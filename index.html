<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å–®è»Šè¿½é¢¨å¤©æ°£ ğŸš´â€â™€ï¸</title>
  <link rel="icon" type="image/png" href="./icon-v2.png" />
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    /* æ‰€æœ‰çš„ CSS æ¨£å¼ä»£ç¢¼ä¿æŒä¸è®Š */
    :root{
      --vivid-blue: #4FB5D9; /* æ´»åŠ›è— */
      --sun-yellow: #F9F195; /* é™½å…‰é»ƒ */
      --light-cloud: #FFFEF2; /* è¼•é›²ç™½ */
      --brown: #796452;
      --dark: #58504A;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Zen Maru Gothic',sans-serif;
      background: linear-gradient(180deg, rgba(79,181,217,0.12), rgba(255,255,255,0.02));
      color:var(--dark);
      -webkit-font-smoothing:antialiased;
      padding:18px;
      /* ä»¥è…³è¸è»Š svg ä½œç‚ºæ¸¸æ¨™ï¼ˆdata URLï¼‰ */
      cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="%234FB5D9" d="M5 16a3 3 0 1 0 0 6 3 3 0 0 0 0-6zm0-2a5 5 0 1 1 0 10 5 5 0 0 1 0-10zM19 16a3 3 0 1 0 0 6 3 3 0 0 0 0-6zm0-2a5 5 0 1 1 0 10 5 5 0 0 1 0-10zM7 10h2l2-4 3 6h3" /></svg>') 12 12, auto;
    }

    .container{
      max-width:720px;
      margin:0 auto;
    }

    /* ç‹€æ…‹åˆ— */
    .status-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:14px;
    }
    .brand {
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-pill{
      background:var(--light-cloud);
      border-radius:14px;
      padding:6px 12px;
      border:4px solid white;
      transform:rotate(-3deg);
      font-weight:900;
      color:var(--dark);
      box-shadow:0 6px 0 rgba(0,0,0,0.06);
      display:flex;
      gap:8px;
      align-items:center;
      font-size:1rem;
      min-width: 150px; /* ç¢ºä¿æœ‰è¶³å¤ ç©ºé–“é¡¯ç¤ºåœ°é» */
    }
    .update-pill{
      background:var(--vivid-blue);
      color:white;
      padding:6px 10px;
      border-radius:14px;
      font-weight:700;
      box-shadow:0 3px 0 rgba(0,0,0,0.08);
      font-size:0.9rem;
    }
    /* ä¿®æ­£ä¸‹æ‹‰é¸å–®æ¨£å¼ */
    #town-select{
        padding: 8px 10px;
        border-radius: 12px;
        border: 2px solid var(--vivid-blue);
        background: white;
        font-family:'Zen Maru Gothic',sans-serif;
        font-weight: 700;
        color: var(--dark);
        margin-left: 10px;
    }


    /* hero card */
    .hero-card{
      background:var(--light-cloud);
      border-radius:28px;
      padding:22px;
      border:4px solid white;
      box-shadow:0 18px 30px rgba(79,181,217,0.08);
      position:relative;
      margin-bottom:18px;
    }
    .hero-tag{
      position:absolute;
      left:18px;
      top:-14px;
      background:var(--sun-yellow);
      color:var(--brown);
      padding:6px 14px;
      border-radius:12px;
      transform:rotate(-6deg);
      font-weight:900;
      border:3px solid white;
    }
    .hero-top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      margin-top:6px;
    }
    .hero-icon{
      font-size:4.4rem;
      filter:drop-shadow(0 6px 0 rgba(0,0,0,0.05));
    }
    /* å‹•æ„Ÿé–ƒé›» */
    .thunder{
      display:inline-block;
      animation: flash 1.1s infinite;
    }
    @keyframes flash{
      0%{transform:translateY(0) scale(1)}
      50%{transform:translateY(-6px) scale(1.05)}
      100%{transform:translateY(0) scale(1)}
    }

    .hero-temp{
      font-size:3.2rem;
      font-weight:900;
      color:var(--dark);
      line-height:1;
    }
    .hero-desc{
      text-align:center;
      font-size:1.1rem;
      font-weight:800;
      color:#6b5a4f;
      margin-top:8px;
    }

    /* å»ºè­°å€ï¼šé¨è¡Œé‡é» */
    .advice-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:16px;
    }
    .advice-item{
      background: rgba(255,255,255,0.9);
      border-radius:14px;
      padding:12px;
      text-align:center;
      border:3px solid white;
      box-shadow:0 6px 0 rgba(0,0,0,0.04);
    }
    .advice-icon{font-size:1.6rem;margin-bottom:6px}
    .advice-title{font-weight:900;color:var(--dark);font-size:0.95rem}
    .advice-sub{font-size:0.85rem;color:#6f665d;margin-top:6px}

    /* é å ±å€ï¼ˆæ©«å‘ï¼‰ */
    .section-title{
      font-weight:900;
      color:var(--vivid-blue);
      margin:8px 6px;
      font-size:1.05rem;
    }
    .scroll-row{
      display:flex;
      gap:12px;
      overflow-x:auto;
      padding-bottom:8px;
    }
    .card-day{
      min-width:150px;
      background:rgba(255,255,255,0.95);
      border-radius:16px;
      padding:12px;
      border:3px solid white;
      text-align:center;
      box-shadow:0 6px 0 rgba(0,0,0,0.03);
    }
    .card-day .day{
      font-weight:900;
      color:var(--dark);
      margin-bottom:6px;
    }
    .card-day .range{font-weight:800;color:#6b5a4f;margin-top:6px}
    .card-day .pop{font-size:0.9rem;margin-top:8px;color:#5f6a74}

    /* loading */
    .loading{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      height:70vh;
      color:var(--vivid-blue);
      font-weight:900;
    }

    /* small screen tweaks */
    @media (max-width:420px){
      .advice-grid{grid-template-columns:1fr 1fr}
      .hero-temp{font-size:2.4rem}
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="status-bar">
      <div class="brand">
        <div class="logo-pill" id="logoPill">ğŸš´ å–®è»Šè¿½é¢¨ Â· å®œè˜­å¸‚</div> 
      </div>
      <div id="select-container">
        <select id="town-select" onchange="fetchWeather()">
          <option value="å®œè˜­å¸‚">å®œè˜­å¸‚</option>
          <option value="ç¾…æ±é®">ç¾…æ±é®</option>
          <option value="è˜‡æ¾³é®">è˜‡æ¾³é®</option>
          <option value="é ­åŸé®">é ­åŸé®</option>
          <option value="ç¤æºªé„‰">ç¤æºªé„‰</option>
          <option value="å£¯åœé„‰">å£¯åœé„‰</option>
          <option value="å“¡å±±é„‰">å“¡å±±é„‰</option>
          <option value="å†¬å±±é„‰">å†¬å±±é„‰</option>
          <option value="äº”çµé„‰">äº”çµé„‰</option>
          <option value="ä¸‰æ˜Ÿé„‰">ä¸‰æ˜Ÿé„‰</option>
          <option value="å¤§åŒé„‰">å¤§åŒé„‰</option>
          <option value="å—æ¾³é„‰">å—æ¾³é„‰</option>
        </select>
      </div>
      <div id="updateTime" class="update-pill">æ›´æ–°ä¸­...</div>
    </div>

    <div id="mainArea">
      <div id="hero" class="hero-card" aria-live="polite">
        <div class="hero-tag">é€±æœ«é¨è¡Œå»ºè­°</div>
        <div id="heroContent" class="hero-top">
          </div>
        <div id="heroDesc" class="hero-desc"></div>

        <div class="advice-grid" id="adviceGrid">
          </div>
      </div>

      <div>
        <h3 class="section-title">ä¸€é€±é å ±ï¼ˆ<span id="forecastTown">å®œè˜­å¸‚</span>ï¼‰</h3>
        <div class="scroll-row" id="weekRow">
          </div>
      </div>
    </div>

    <div id="loading" class="loading" style="display:flex;">
      <div style="font-size:3.8rem">ğŸš´â€â™€ï¸</div>
      <div style="margin-top:12px">æ­£åœ¨ç‚ºä½ åµæ¸¬é¢¨å‘èˆ‡å¡åº¦ï¼Œæº–å‚™å‡ºç™¼â€¦</div>
    </div>
  </div>

  <script>
    // åˆ¤æ–·ç•¶å‰ç’°å¢ƒï¼Œè‡ªå‹•åˆ‡æ› API ç¶²å€ï¼Œä¸¦å°‡é è¨­é„‰é®è¨­ç‚ºå®œè˜­å¸‚
    const BASE_API_URL = 
      location.hostname === "localhost" || location.hostname === "127.0.0.1"
        ? "http://localhost:3000/api/weather/yilan"
        : "https://cwaweather.zeabur.app/api/weather/yilan";

    function parseNumberFromString(s){
      if (!s) return null;
      const m = (""+s).match(/-?\d+(\.\d+)?/);
      return m ? Number(m[0]) : null;
    }

    // ... (å…¶ä»–è¼”åŠ©å‡½å¼ä¿æŒä¸è®Šï¼Œç•¥é)
    function windLevelText(wsValue){
      const n = parseNumberFromString(wsValue);
      if (n === null) return "â€”";
      if (n <= 3) return "å¾®é¢¨ (é©åˆé¨è¡Œ)";
      if (n <= 6) return "æœ‰æ„Ÿé¢¨é€Ÿ (å°å¿ƒå´é¢¨)";
      return "å¼·é¢¨ (å»ºè­°æ–Ÿé…Œé¨ä¹˜)";
    }

    function pickIconFromWx(wx){
      if (!wx) return "ğŸš´â€â™‚ï¸";
      if (wx.includes("æ™´")) return "ğŸš´â€â™‚ï¸";
      if (wx.includes("å¤šé›²")) return "ğŸŒ¥ï¸";
      if (wx.includes("é™°")) return "â˜ï¸";
      if (wx.includes("é›·")) return '<span class="thunder">âš¡</span>';
      if (wx.includes("é›¨")) return "ğŸŒ§ï¸";
      return "ğŸš´â€â™‚ï¸";
    }

    function comfortFromCI(ci){
      if (!ci) return "â€”";
      if (ci.includes("èˆ’é©") || ci.includes("é©")) return "æ¥µèˆ’é©";
      if (ci.includes("æ‚¶ç†±") || ci.includes("ç‚ç†±")) return "ç‚ç†±ï¼Œæ³¨æ„è£œæ°´";
      if (ci.includes("åå†·") || ci.includes("å¯’å†·")) return "åå†·ï¼Œæ³¨æ„ä¿æš–";
      return ci;
    }

    function createAdviceBlock(icon, title, sub){
      return `<div class="advice-item">
                <div class="advice-icon">${icon}</div>
                <div class="advice-title">${title}</div>
                <div class="advice-sub">${sub || ""}</div>
              </div>`;
    }

    function formatDateLabel(startTime){
      if (!startTime) return "";
      const d = new Date(startTime);
      const now = new Date();
      const days = ["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"];
      const isToday = d.toDateString() === now.toDateString();
      const tomorrow = new Date();
      tomorrow.setDate(now.getDate()+1);
      const isTomorrow = d.toDateString() === tomorrow.toDateString();
      if (isToday) return "ä»Šå¤©";
      if (isTomorrow) return "æ˜å¤©";
      return `${d.getMonth()+1}/${d.getDate()} ${days[d.getDay()]}`;
    }


    function render(data){
      if (!data || !data.forecasts) {
        alert("å¤©æ°£è³‡æ–™æ ¼å¼éŒ¯èª¤");
        return;
      }
      document.getElementById('loading').style.display = 'none';
      document.getElementById('mainArea').style.display = 'block';

      const forecasts = data.forecasts;
      const currentCity = data.city || 'å®œè˜­å¸‚'; // å¾å¾Œç«¯å›å‚³çš„ city åç¨±

      // æ›´æ–°é é¢æ¨™é¡Œèˆ‡åœ°é»é¡¯ç¤º
      document.getElementById('logoPill').textContent = `ğŸš´ å–®è»Šè¿½é¢¨ Â· ${currentCity}`;
      document.getElementById('forecastTown').textContent = currentCity;
      
      // ä»¥æ¯æ—¥ç¬¬ä¸€å€‹ time slot ç•¶ä½œè©²æ—¥ä»£è¡¨ (F-D0047-003 é€šå¸¸ç‚ºæ—¥é–“åˆ†æ®µ)
      const byDate = {};
      forecasts.forEach(f => {
        const dKey = f.startTime ? (new Date(f.startTime)).toDateString() : f.startTime;
        if (!byDate[dKey]) byDate[dKey] = [];
        byDate[dKey].push(f);
      });

      const dateKeys = Object.keys(byDate).slice(0,7); // æœ€å¤š 7 å¤©
      const days = dateKeys.map(k => byDate[k][0]); // å–è©²æ—¥ç¬¬ä¸€ç­†

      // Hero é¡¯ç¤ºï¼šå–ç¬¬ä¸€ç­†ï¼ˆæœ€è¿‘ï¼‰
      const nowItem = forecasts[0] || days[0];

      const heroIcon = pickIconFromWx(nowItem.wx);
      const minT = parseNumberFromString(nowItem.minT) || 0;
      const maxT = parseNumberFromString(nowItem.maxT) || 0;
      const avgT = Math.round((minT + maxT)/2);
      const pop = nowItem.pop || "â€”";
      const ciText = comfortFromCI(nowItem.ci);
      const ws = nowItem.ws || "â€”";
      const windText = windLevelText(ws);

      document.getElementById('heroContent').innerHTML = `
        <div style="text-align:center">
          <div class="hero-icon">${heroIcon}</div>
        </div>
        <div style="text-align:center">
          <div class="hero-temp">${avgT}Â°</div>
          <div style="font-size:0.95rem;margin-top:6px;font-weight:800">${nowItem.wx}</div>
        </div>
      `;
      document.getElementById('heroDesc').textContent = `é™é›¨ï¼š${pop}%  Â·  é«”æ„Ÿï¼š${ciText}  Â·  é¢¨æ³ï¼š${windText}`;

      // å»ºè­°å€ï¼ˆ3 æ ¼ï¼šé¨è¡Œç©©å®šåº¦ã€é«”æ„Ÿèˆ’é©ã€é™é›¨é¢¨éšªï¼‰
      const advEl = document.getElementById('adviceGrid');
      advEl.innerHTML = "";
      advEl.innerHTML += createAdviceBlock("ğŸŒªï¸", "é¢¨é€Ÿç­‰ç´š", windText);
      advEl.innerHTML += createAdviceBlock("ğŸŒ¡ï¸", "é«”æ„Ÿèˆ’é©åº¦", ciText);
      const rainRiskText = (parseNumberFromString(pop) >= 50) ? "é«˜é™é›¨é¢¨éšªï¼Œå»ºè­°å»¶æœŸæˆ–å¸¶é˜²é›¨è£å‚™" : "é™é›¨æ©Ÿç‡ä½ï¼Œé©åˆå‡ºç™¼";
      advEl.innerHTML += createAdviceBlock("ğŸ’§", "é™é›¨é¢¨éšª", `${pop}% â€¢ ${rainRiskText}`);

      // ä¸€é€±é å ±å¡
      const row = document.getElementById('weekRow');
      row.innerHTML = "";
      days.forEach(d => {
        const icon = pickIconFromWx(d.wx);
        const popText = d.pop || "â€”";
        const minV = d.minT || "â€”";
        const maxV = d.maxT || "â€”";
        const label = formatDateLabel(d.startTime);
        row.innerHTML += `
          <div class="card-day">
            <div class="day">${label}</div>
            <div class="big-icon" style="font-size:2.2rem">${icon}</div>
            <div class="range">${minV}Â° - ${maxV}Â°</div>
            <div class="pop">ğŸ’§ é™é›¨ ${popText}%</div>
            <div style="margin-top:6px;font-size:0.85rem;color:#6b5a4f">é«”æ„Ÿï¼š${comfortFromCI(d.ci)}</div>
          </div>
        `;
      });

      // æ›´æ–°å³ä¸Šæ›´æ–°æ™‚é–“
      const now = new Date();
      const months = now.getMonth()+1;
      const dates = now.getDate();
      const daysArr = ["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"];
      document.getElementById('updateTime').textContent = `${months}æœˆ${dates}æ—¥ ${daysArr[now.getDay()]}`;
    }

    async function fetchWeather(){
      document.getElementById('mainArea').style.display = 'none';
      document.getElementById('loading').style.display = 'flex';
      
      // 1. å–å¾—é¸æ“‡çš„é„‰é®åç¨±
      const selectElement = document.getElementById('town-select');
      // å¦‚æœé¸å–®ä¸å­˜åœ¨æˆ–ç„¡å€¼ï¼Œé è¨­ç‚ºã€Œå®œè˜­å¸‚ã€
      const selectedTown = selectElement ? selectElement.value : 'å®œè˜­å¸‚'; 
      
      // 2. å»ºæ§‹å‹•æ…‹ API URL: BASE_API_URL/é„‰é®åç¨±
      const API_URL = `${BASE_API_URL}/${selectedTown}`;
      
      try{
        const resp = await fetch(API_URL);
        const json = await resp.json();
        
        // æª¢æŸ¥ json.success (å¾Œç«¯ server.js æœƒæ˜ç¢ºå›å‚³ success: true æˆ– false)
        if (!json.success) {
          throw new Error(`API å›å‚³éŒ¯èª¤ï¼š${json.message || json.error || 'æœªçŸ¥éŒ¯èª¤'}`);
        }
        
        render(json);
      }catch(e){
        console.error(e);
        alert(`è®€å– ${selectedTown} å¤©æ°£å¤±æ•—ï¼š${e.message}ã€‚è«‹ç¢ºèªå¾Œç«¯ä¼ºæœå™¨èˆ‡ API key è¨­å®šæ˜¯å¦æ­£ç¢ºï¼ˆæª¢æŸ¥ CORS èˆ‡ç¶²åŸŸï¼‰`);
        document.getElementById('loading').style.display = 'none';
      }
    }

    // é é¢è¼‰å…¥æ™‚ï¼Œç«‹å³åŸ·è¡ŒæŸ¥è©¢ (é è¨­æ˜¯ã€Œå®œè˜­å¸‚ã€)
    document.addEventListener("DOMContentLoaded", fetchWeather);
  </script>
</body>
</html>
